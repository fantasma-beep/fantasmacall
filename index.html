<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FantasmaCall - Llamadas Grupales</title>
    <!-- Incluimos la librería PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="icon" href="https://i.ibb.co/9vR9zM8/logo-fantasma-fondo.png" type="image/png">
    <link rel="apple-touch-icon" href="https://i.ibb.co/9vR9zM8/logo-fantasma-fondo.png">
    <meta name="theme-color" content="#202124">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #202124;
            color: #E8EAED;
        }
        .control-button {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 12px;
            transition: background-color 0.2s ease-in-out; cursor: pointer;
        }
        .control-button:hover { background-color: #3c4043; }
        .control-button.active { background-color: #4A4A4A; }
        .control-button.end-call { background-color: #EA4335; }
        .control-button.end-call:hover { background-color: #D93025; }
        .video-container {
            position: relative; overflow: hidden; border-radius: 12px; background-color: #2D2E30;
            transition: all 0.3s ease-in-out;
        }
        .video-container video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .participant-name {
            position: absolute; bottom: 8px; left: 8px; background-color: rgba(0, 0, 0, 0.5);
            color: white; padding: 4px 8px; border-radius: 6px; font-size: 14px; z-index: 2;
        }
        .chat-message { padding: 8px 12px; border-radius: 18px; margin-bottom: 8px; max-width: 80%; }
        .chat-message.sent { background-color: #3B82F6; align-self: flex-end; color: white; }
        .chat-message.received { background-color: #4A4A4A; align-self: flex-start; }
        button:disabled { cursor: not-allowed; }
        #video-grid-container {
            background-image: url('LOGOFONDO.png');
            background-repeat: repeat;
            background-size: 150px; 
            background-color: #202124;
        }
        #video-grid-container.fullscreen-mode { background-image: none; }
        #video-grid-container.fullscreen-mode .video-container:not(.fullscreen) { display: none; }
        .video-container.fullscreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 0; z-index: 20;
        }
        .video-overlay-button {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            padding: 6px;
            cursor: pointer;
            z-index: 3;
            transition: transform 0.2s;
        }
        .video-overlay-button:hover { transform: scale(1.1); }
        .fullscreen-btn { top: 8px; right: 8px; }
        .switch-camera-btn { top: 8px; left: 8px; }
        .admin-controls {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            flex-direction: row;
            gap: 16px;
            z-index: 4;
            background-color: rgba(0,0,0,0.4);
            padding: 8px;
            border-radius: 99px;
        }
        .video-container:hover .admin-controls {
            display: flex;
        }
        .admin-controls .video-overlay-button{
            position: static;
        }
    </style>
</head>
<body class="flex items-center justify-center h-screen">

    <!-- Pantalla de Conexión -->
    <div id="connection-screen" class="text-center p-4">
        <img src="LOGOFANTASMA.jpg" alt="Logo de FantasmaCall" class="mx-auto mb-4 w-24 h-24 rounded-full">
        <h1 class="text-4xl font-bold mb-2">FantasmaCall</h1>
        <p class="text-lg text-gray-300 mb-6">Tu ID para que otros se unan:</p>
        <div class="flex items-center justify-center bg-gray-700 p-2 rounded-lg mb-6 max-w-sm mx-auto">
            <span id="my-id" class="text-lg font-mono text-green-400">Obteniendo ID...</span>
            <button id="copy-id-btn" class="ml-4 p-2 rounded-lg bg-blue-600 hover:bg-blue-700 transition" title="Copiar ID">
                <svg class="w-5 h-5" fill="white" viewBox="0 0 20 20"><path d="M7 3a1 1 0 011-1h5a1 1 0 011 1v2h1.5a1.5 1.5 0 011.5 1.5v9a1.5 1.5 0 01-1.5 1.5h-9A1.5 1.5 0 013 15.5v-9A1.5 1.5 0 014.5 5H6V3a1 1 0 011-1zM6 5v1h8V5h-1v1a1 1 0 01-1 1H8a1 1 0 01-1-1V5H6z"></path></svg>
            </button>
        </div>
        <p class="text-lg text-gray-300 mb-4">Ingresa el ID de alguien en la llamada para unirte:</p>
        <div class="flex justify-center">
            <input type="text" id="friend-id" placeholder="ID de un participante..." class="w-64 px-4 py-2 rounded-l-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="call-btn" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-r-lg hover:bg-green-700 transition">Unirse</button>
        </div>
    </div>

    <!-- Pantalla de la Llamada -->
    <div id="call-screen" class="hidden w-full h-full flex flex-col">
        <div class="flex-1 flex flex-col sm:flex-row overflow-hidden">
            <main class="flex-1 p-2 sm:p-4 relative" id="video-grid-container">
                 <div id="video-grid" class="w-full h-full grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
            </main>
            <aside id="chat-panel" class="w-full sm:w-80 bg-gray-800 flex-col h-full border-l border-gray-700 hidden">
                <div class="p-4 border-b border-gray-700"><h2 class="text-lg font-semibold">Chat</h2></div>
                <div id="messages" class="flex-1 p-4 overflow-y-auto flex flex-col"></div>
                <div class="p-4 border-t border-gray-700">
                    <form id="chat-form" class="flex">
                        <input type="text" id="chat-input" placeholder="Escribe..." autocomplete="off" class="flex-1 px-3 py-2 rounded-l-lg bg-gray-700 border border-gray-600 focus:outline-none">
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-r-lg hover:bg-blue-700">Enviar</button>
                    </form>
                </div>
            </aside>
        </div>
        <footer class="w-full bg-black bg-opacity-30 p-2 sm:p-4">
            <div class="max-w-4xl mx-auto flex justify-center items-center space-x-2 sm:space-x-4">
                <div id="mute-btn" class="control-button w-16 h-14 sm:w-20 sm:h-16">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                    <span class="text-xs mt-1">Silenciar</span>
                </div>
                <div id="video-btn" class="control-button w-16 h-14 sm:w-20 sm:h-16">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    <span class="text-xs mt-1">Video</span>
                </div>
                <div id="chat-btn" class="control-button w-16 h-14 sm:w-20 sm:h-16">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                    <span class="text-xs mt-1">Chat</span>
                </div>
                <div id="end-call-btn" class="control-button end-call w-16 h-14 sm:w-20 sm:h-16">
                    <svg class="w-6 h-6" fill="white" viewBox="0 0 24 24"><path d="M3.5 6.5C3.5 5.94772 3.94772 5.5 4.5 5.5H7.52503C7.99416 5.5 8.41164 5.75015 8.6521 6.16209L10.0521 8.56209C10.273 8.93791 10.273 9.41209 10.0521 9.78791L8.6521 12.1879C8.41164 12.6 7.99416 12.85 7.52503 12.85H5.5C4.94772 12.85 4.5 12.4023 4.5 11.85V6.5H3.5ZM3.5 6.5C2.94772 6.5 2.5 6.94772 2.5 7.5V11.85C2.5 13.5023 3.84772 14.85 5.5 14.85H7.52503C8.77534 14.85 9.87116 14.03 10.3521 12.8879L11.7521 10.4879C12.3129 9.45609 12.3129 8.20391 11.7521 7.16209L10.3521 4.76209C9.87116 3.62 8.77534 2.85 7.52503 2.85H4.5C3.5056 2.85 2.62233 3.41121 2.21948 4.28816L1.61625 5.5786C1.53696 5.74833 1.5 5.93581 1.5 6.1293V17.8707C1.5 18.0642 1.53696 18.2517 1.61625 18.4214L2.21948 19.7118C2.62233 20.5888 3.5056 21.15 4.5 21.15H20.5C21.3284 21.15 22 20.4784 22 19.65V18.5" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    <span class="text-xs mt-1">Salir</span>
                </div>
            </div>
        </footer>
    </div>
    
    <script>
        // --- Referencias a Elementos del DOM ---
        const connectionScreen = document.getElementById('connection-screen');
        const callScreen = document.getElementById('call-screen');
        const myIdSpan = document.getElementById('my-id');
        const copyIdBtn = document.getElementById('copy-id-btn');
        const friendIdInput = document.getElementById('friend-id');
        const callBtn = document.getElementById('call-btn');
        const videoGridContainer = document.getElementById('video-grid-container');
        const videoGrid = document.getElementById('video-grid');
        const muteBtn = document.getElementById('mute-btn');
        const videoBtn = document.getElementById('video-btn');
        const endCallBtn = document.getElementById('end-call-btn');
        const chatBtn = document.getElementById('chat-btn');
        const chatPanel = document.getElementById('chat-panel');
        const messagesDiv = document.getElementById('messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        
        // --- Estado de la Aplicación ---
        let peer;
        let localStream;
        let isMuted = false;
        let isVideoOff = false;
        const calls = {};
        const dataConnections = {};
        let myName = `Fantasma-${Math.floor(Math.random() * 1000)}`;
        const participants = {};
        let videoDevices = [];
        let currentCameraIndex = 0;

        // --- Lógica de Conexión (PeerJS) ---
        const setupDataConnection = (conn) => {
            conn.on('data', (data) => handleData(conn.peer, data));
            conn.on('close', () => removeParticipant(conn.peer));
            conn.on('open', () => {
                dataConnections[conn.peer] = conn;
                conn.send({ type: 'request-peer-list' });
            });
        };

        const handleData = (fromId, data) => {
            switch (data.type) {
                case 'chat':
                    displayMessage(data.fromName, data.message, false);
                    break;
                case 'chat-notification':
                    if (chatPanel.classList.contains('hidden')) {
                        chatPanel.classList.remove('hidden');
                        chatPanel.classList.add('flex');
                    }
                    break;
                case 'request-peer-list':
                    const peerList = Object.keys(participants).filter(id => id !== peer.id && id !== fromId);
                    if (dataConnections[fromId]) {
                        dataConnections[fromId].send({ type: 'peer-list', peers: peerList });
                        dataConnections[fromId].send({ type: 'user-info', peerId: peer.id, name: myName });
                    }
                    break;
                case 'peer-list':
                    data.peers.forEach(peerId => {
                        if (!participants[peerId] && peerId !== peer.id) {
                             makeCall(peerId);
                        }
                    });
                    break;
                case 'user-info':
                    participants[data.peerId] = { name: data.name };
                    updateParticipantName(data.peerId, data.name);
                    break;
                 case 'force-mute':
                    if (!isMuted) muteBtn.click();
                    break;
                case 'request-unmute':
                    if (confirm(`${participants[fromId]?.name || 'El anfitrión'} te pide que reactives tu micrófono. ¿Aceptar?`)) {
                        if (isMuted) muteBtn.click();
                    }
                    break;
                case 'mute-update':
                    if (participants[data.peerId]) participants[data.peerId].isMuted = data.isMuted;
                    updateRemoteMuteIcon(data.peerId, data.isMuted);
                    break;
                case 'force-kick':
                    alert('Has sido eliminado de la llamada.');
                    endCall();
                    break;
                case 'user-disconnected':
                    removeParticipant(data.peerId);
                    break;
            }
        };

        const initializePeer = async () => {
            friendIdInput.disabled = true;
            callBtn.disabled = true;
            callBtn.textContent = 'Conectando...';
            callBtn.classList.add('bg-gray-500');

            try {
                const requestedName = prompt("Ingresa tu nombre para el chat:", myName);
                if (requestedName) myName = requestedName;

                await setupLocalMedia();
                addVideoStream('local', myName, localStream, true);

                peer = new Peer({
                    host: 'peerjs.92k.de',
                    secure: true,
                    port: 443,
                    path: '/'
                });

                peer.on('open', (id) => {
                    myIdSpan.textContent = id;
                    participants[id] = { name: myName, isMuted: false };
                    const localVideoContainer = document.getElementById('container-local');
                    if (localVideoContainer) {
                        localVideoContainer.id = `container-${id}`;
                        addCameraSwitchButton(id);
                    }
                    
                    friendIdInput.disabled = false;
                    callBtn.disabled = false;
                    callBtn.textContent = 'Unirse';
                    callBtn.classList.remove('bg-gray-500');
                });

                peer.on('call', (call) => {
                    showCallScreen();
                    answerCall(call);
                });

                peer.on('connection', (conn) => setupDataConnection(conn));
                peer.on('error', (err) => {
                    console.error('Error de PeerJS:', err);
                    alert('Error de conexión. Intenta recargar la página.');
                });

            } catch (error) {
                alert("No se pudo acceder a tu cámara y micrófono. Revisa los permisos.");
            }
        };

        const answerCall = (call) => {
            const callerId = call.peer;
            call.answer(localStream);
            calls[callerId] = call;
            call.on('stream', (remoteStream) => {
                addVideoStream(callerId, participants[callerId]?.name || 'Usuario', remoteStream);
            });
            call.on('close', () => removeParticipant(callerId));

            if (!dataConnections[callerId]) {
                const conn = peer.connect(callerId, { reliable: true });
                setupDataConnection(conn);
            }
        };

        const makeCall = (friendId) => {
            if (!friendId || calls[friendId] || dataConnections[friendId] || friendId === peer.id) return;
            showCallScreen();
            
            const conn = peer.connect(friendId, { reliable: true });
            setupDataConnection(conn);
            
            const call = peer.call(friendId, localStream);
            calls[friendId] = call;

            call.on('stream', (remoteStream) => {
                addVideoStream(friendId, 'Conectando...', remoteStream);
            });
            call.on('close', () => removeParticipant(friendId));
        };
        
        const broadcastData = (data) => {
             Object.values(dataConnections).forEach(conn => {
                if(conn && conn.open) conn.send(data)
             });
        }

        const displayMessage = (fromName, message, isSent) => {
            const messageEl = document.createElement('div');
            messageEl.textContent = message;
            messageEl.className = isSent ? 'chat-message sent' : 'chat-message received';
            const senderEl = document.createElement('div');
            senderEl.className = 'text-xs text-gray-400 mb-1';
            senderEl.textContent = isSent ? 'Tú' : fromName;
            const container = document.createElement('div');
            container.className = `w-full flex flex-col ${isSent ? 'items-end' : 'items-start'}`;
            container.appendChild(senderEl);
            container.appendChild(messageEl);
            messagesDiv.appendChild(container);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        };
        
        const sendMessage = (e) => {
            e.preventDefault();
            const message = chatInput.value;
            if (message.trim() === '') return;
            const data = { type: 'chat', fromName: myName, message: message };
            const notification = { type: 'chat-notification' };

            broadcastData(data);
            broadcastData(notification);

            displayMessage('Tú', message, true);
            chatInput.value = '';
        };

        const addVideoStream = (id, name, stream, isMuted = false) => {
            if (document.getElementById(`container-${id}`)) return;
            const container = document.createElement('div');
            container.id = `container-${id}`;
            container.className = 'video-container aspect-video';
            const video = document.createElement('video');
            video.srcObject = stream;
            
            video.addEventListener('loadedmetadata', () => {
                video.play().catch(e => console.error("Error al reproducir el video:", e));
            });

            video.autoplay = true;
            video.playsInline = true;
            video.muted = isMuted;
            container.appendChild(video);
            
            const nameTag = document.createElement('div');
            nameTag.className = 'participant-name';
            nameTag.textContent = name;
            container.appendChild(nameTag);
            
            const fullscreenBtn = document.createElement('div');
            fullscreenBtn.className = 'video-overlay-button fullscreen-btn';
            fullscreenBtn.innerHTML = `<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5-5"></path></svg>`;
            fullscreenBtn.onclick = (e) => {
                e.stopPropagation();
                toggleFullscreen(container);
            };
            container.appendChild(fullscreenBtn);

             if (id !== 'local' && id !== (peer ? peer.id : '')) {
                const adminControls = document.createElement('div');
                adminControls.className = 'admin-controls';

                const remoteMuteBtn = document.createElement('div');
                remoteMuteBtn.id = `mute-btn-${id}`;
                remoteMuteBtn.className = 'video-overlay-button';
                remoteMuteBtn.title = 'Silenciar/Reactivar participante';
                remoteMuteBtn.innerHTML = `<svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v1a7 7 0 0 1-14 0v-1"></path><line x1="8" y1="23" x2="16" y2="23"></line></svg>`;
                remoteMuteBtn.onclick = (e) => {
                    e.stopPropagation();
                    const targetIsMuted = participants[id]?.isMuted;
                    if (dataConnections[id]) {
                        if (targetIsMuted) {
                            dataConnections[id].send({ type: 'request-unmute' });
                        } else {
                            dataConnections[id].send({ type: 'force-mute' });
                        }
                    }
                };
                adminControls.appendChild(remoteMuteBtn);

                const kickBtn = document.createElement('div');
                kickBtn.className = 'video-overlay-button';
                kickBtn.title = 'Expulsar participante';
                kickBtn.innerHTML = `<svg class="w-5 h-5 text-red-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line></svg>`;
                kickBtn.onclick = (e) => {
                    e.stopPropagation();
                    broadcastData({ type: 'user-disconnected', peerId: id });
                    removeParticipant(id);
                };
                adminControls.appendChild(kickBtn);
                container.appendChild(adminControls);
            }
            
            videoGrid.appendChild(container);
        };
        
        const updateRemoteMuteIcon = (peerId, isMuted) => {
            const remoteMuteBtn = document.getElementById(`mute-btn-${peerId}`);
            if (remoteMuteBtn) {
                if (isMuted) {
                    remoteMuteBtn.innerHTML = `<svg class="w-5 h-5 text-red-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>`;
                } else {
                    remoteMuteBtn.innerHTML = `<svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v1a7 7 0 0 1-14 0v-1"></path><line x1="8" y1="23" x2="16" y2="23"></line></svg>`;
                }
            }
        };

        const addCameraSwitchButton = (id) => {
            if (videoDevices.length > 1) {
                const container = document.getElementById(`container-${id}`);
                if(container && !container.querySelector('.switch-camera-btn')) {
                    const switchCamBtn = document.createElement('div');
                    switchCamBtn.className = 'video-overlay-button switch-camera-btn';
                    switchCamBtn.innerHTML = `<svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path><path d="M20.49 15a9 9 0 0 1-14.85 3.36L1 14"></path></svg>`;
                    switchCamBtn.onclick = (e) => {
                        e.stopPropagation();
                        switchCamera();
                    };
                    container.appendChild(switchCamBtn);
                }
            }
        };

        const setupLocalMedia = async (deviceId = undefined) => {
             const constraints = {
                video: { deviceId: deviceId ? { exact: deviceId } : undefined },
                audio: true,
            };
            localStream = await navigator.mediaDevices.getUserMedia(constraints);

            if (!videoDevices.length) {
                const devices = await navigator.mediaDevices.enumerateDevices();
                videoDevices = devices.filter(d => d.kind === 'videoinput');
            }
        };

        const switchCamera = async () => {
            if (videoDevices.length < 2) return;
            currentCameraIndex = (currentCameraIndex + 1) % videoDevices.length;
            const nextCameraId = videoDevices[currentCameraIndex].deviceId;

            const newVideoStream = await navigator.mediaDevices.getUserMedia({
                video: { deviceId: { exact: nextCameraId } }
            });
            const newVideoTrack = newVideoStream.getVideoTracks()[0];
            
            const localVideo = document.querySelector(`#container-${peer.id} video`);
            const oldVideoTrack = localStream.getVideoTracks()[0];
            localStream.removeTrack(oldVideoTrack);
            oldVideoTrack.stop();
            localStream.addTrack(newVideoTrack);
            
            if (localVideo) localVideo.srcObject = localStream;

            Object.values(calls).forEach(call => {
                const sender = call.peerConnection.getSenders().find(s => s.track.kind === 'video');
                if (sender) {
                    sender.replaceTrack(newVideoTrack);
                }
            });
        };

        const toggleFullscreen = (container) => {
            const isFullscreen = container.classList.contains('fullscreen');
            const btn = container.querySelector('.fullscreen-btn');
            document.querySelector('.fullscreen')?.classList.remove('fullscreen');
            
            if (!isFullscreen) {
                container.classList.add('fullscreen');
                btn.innerHTML = `<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l-5 5m0 0V15m0 4h4m11-5l-5 5m0 0V15m0 4h-4M14 10l5-5m0 0V9m0-4h-4M5 9l5-5m0 0V9m0-4H9"></path></svg>`;
            } else {
                 btn.innerHTML = `<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5-5"></path></svg>`;
            }
            videoGridContainer.classList.toggle('fullscreen-mode', !isFullscreen);
        };

        const updateParticipantName = (peerId, name) => {
            const nameTag = document.querySelector(`#container-${peerId} .participant-name`);
            if (nameTag) nameTag.textContent = name;
        };
        
        const removeParticipant = (peerId) => {
            const container = document.getElementById(`container-${peerId}`);
            if (container) container.remove();
            if (calls[peerId]) {
                calls[peerId].close();
                delete calls[peerId];
            }
            if (dataConnections[peerId]) {
                dataConnections[peerId].close();
                delete dataConnections[peerId];
            }
            if (participants[peerId]) delete participants[peerId];
        };

        const endCall = () => {
            broadcastData({ type: 'user-disconnected', peerId: peer.id });

            setTimeout(() => {
                window.location.reload();
            }, 100);
        };
        
        const showCallScreen = () => {
            connectionScreen.style.display = 'none';
            callScreen.style.display = 'flex';
        };

        const showConnectionScreen = () => {
            callScreen.style.display = 'none';
            connectionScreen.style.display = 'block';
            Array.from(videoGrid.children).forEach(child => {
                if(child.id !== `container-${peer.id}`) {
                    child.remove();
                }
            });
            friendIdInput.value = '';
            messagesDiv.innerHTML = '';
        };

        copyIdBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(myIdSpan.textContent).then(() => alert('¡ID copiado!'));
        });
        callBtn.addEventListener('click', () => makeCall(friendIdInput.value));
        endCallBtn.addEventListener('click', endCall);
        chatForm.addEventListener('submit', sendMessage);
        chatBtn.addEventListener('click', () => {
            chatPanel.classList.toggle('hidden');
            chatPanel.classList.toggle('flex');
        });

        muteBtn.addEventListener('click', () => {
            if (!localStream) return;
            isMuted = !isMuted;
            localStream.getAudioTracks()[0].enabled = !isMuted;
            muteBtn.classList.toggle('active', isMuted);
            muteBtn.querySelector('span').textContent = isMuted ? 'Reactivar' : 'Silenciar';
            broadcastData({ type: 'mute-update', peerId: peer.id, isMuted: isMuted });
        });

        videoBtn.addEventListener('click', () => {
            if (!localStream) return;
            isVideoOff = !isVideoOff;
            localStream.getVideoTracks()[0].enabled = !isVideoOff;
            videoBtn.classList.toggle('active', isVideoOff);
            videoBtn.querySelector('span').textContent = isVideoOff ? 'Activar' : 'Video';
        });
        
        initializePeer();
    </script>
</body>
</html>

